name: Retrain
on:
  workflow_dispatch:
jobs:
  retrain:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -e ".[dev]"
      - name: Full pipeline
        run: |
          python scripts/download_data.py
          python -m src.pipelines.train
          python -m src.pipelines.evaluate
          python -m src.pipelines.package_model
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: model-artifacts
          path: |
            artifacts/model/
            artifacts/metrics/
            artifacts/baselines/
            artifacts/model_card.md
      - name: Compare metrics (optional gate)
        id: gate
        run: |
          if [ -f artifacts/metrics/metrics.json ]; then
            AUC=$(python -c "import json; print(json.load(open('artifacts/metrics/metrics.json')).get('roc_auc', 0))")
            echo "roc_auc=$AUC" >> $GITHUB_OUTPUT
            echo "AUC: $AUC"
          fi
