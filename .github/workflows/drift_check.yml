name: Drift check
on:
  schedule:
    - cron: "0 8 * * 1"  # Weekly Monday 08:00 UTC
  workflow_dispatch:
jobs:
  drift:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - run: pip install -e ".[dev]"
      - name: Get data and baseline
        run: |
          python scripts/download_data.py
          python -m src.pipelines.train
          python -m src.pipelines.package_model
      - name: Run drift check
        id: drift
        run: |
          python -m src.monitoring.drift
          if [ -f artifacts/metrics/drift_report.json ]; then
            DRIFT=$(python -c "import json; d=json.load(open('artifacts/metrics/drift_report.json')); print(d.get('drift_detected', False))")
            echo "drift_detected=$DRIFT" >> $GITHUB_OUTPUT
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi
      - name: Create Issue on drift
        if: steps.drift.outputs.drift_detected == 'True'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.existsSync('artifacts/metrics/drift_report.json')
              ? '```json\n' + fs.readFileSync('artifacts/metrics/drift_report.json', 'utf8') + '\n```'
              : 'Drift detected. See workflow run for details.';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Drift alert: feature or score distribution shift',
              body
            });
